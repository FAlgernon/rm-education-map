var UseModal=false;var rmData={};var clndr={};var rskm=function(){var e=$("#filter-menu");var t=$("#filter-topic");var n=$("#filter-results");var r=[];modalTemplate=_.template($("#modal-template").html());var i=false;var s=false;var o={program_code:Array(),location_code:Array(),month:false};var u=[];var a=[];var f=false;var l=[];var c=function(e){if(e!=null){i=e.modal||false}w();o.month=h();m(o.month,l);g();$("#filter-topic input").on("change",p);$("#filter-location input").on("change",d);$("#filter-menu>a").on("click",v);clndr.passInEvents=$("#pass-in-events").clndr({template:$("#clndr-template").html(),events:l,startWithMonth:f||l[0].date,clickEvents:{onMonthChange:function(e){rskm.newMonth(e.month());rskm.filter()},click:function(e){if(e.events.length>0){$(".highLightRow").removeClass("highLightRow");$(".event-row-"+e.date._i).addClass("highLightRow")}},onYearChange:function(e){}}})};var h=function(){var e=new Date;var t=e.getMonth();var n=new Date(l[0].date);var r=n.getMonth();f=e<n?n:e;return t<r?r:t};var p=function(e){$(this).parent("label").parent("li").toggleClass("active");value=e.target.value;index=_.indexOf(o.program_code,value);if(index>=0){o.program_code.splice(index,1)}else{o.program_code.push(value)}g()};var d=function(e){$(this).parent("label").parent("li").toggleClass("active");value=e.target.value;index=_.indexOf(o.location_code,value);if(index>=0){o.location_code.splice(index,1)}else{o.location_code.push(value)}g()};var v=function(e){e.preventDefault();menu=$(this).attr("rel");$(".toggledVisible").removeClass("toggledVisible");$("#"+menu).addClass("toggledVisible");$("#filter-menu > a").removeClass("tabOn");$(this).addClass("tabOn")};var m=function(e,t){return _.filter(t,function(t){return(new Date(t.date)).getMonth()==e},this)};var g=function(e){a=new Array;_.each(l,function(e){_topic=o.program_code.length>0?_.contains(o.program_code,e.program_code):true;_location=o.location_code.length>0?_.contains(o.location_code,e.location_code.replace(/[0-9]/g,"")):true;_date=(new Date(e.date)).getMonth()==o.month;if(_topic&&_location&&_date){a.push(e)}},this);y()};var y=function(){$("#filter-results tr td").parent().remove();if(a.length<1){$("#filter-results").append('<tr><td colspan="3">No results found</td></tr>')}else{_.each(a,b)}};var b=function(e){if(e!="undefined"&&e!=null){var t=modalTemplate({title:e.title,code:e.code,date:e.date,description:e.program_description,phone:e.phone,url:e.register_url,address:e.address,location_name:e.location,city:e.city});row=document.createElement("tr");row.className="event-row-"+moment(e.date).format("YYYY-MM-DD");td1=document.createElement("td");td2=document.createElement("td");td2.appendChild(document.createTextNode(""+e.date));td3=document.createElement("td");tx3=document.createTextNode(""+e.city+", "+e.location);td3.appendChild(tx3);txt=document.createTextNode(""+e.title);lnkA=document.createElement("a");lnkA.href=e.register_url;lnkA.appendChild(txt);td1.appendChild(lnkA);row.appendChild(td1);row.appendChild(td2);row.appendChild(td3);$("#filter-results").append(row);if(i&&jQuery().appOverlay){$(lnkA).appOverlay({type:"compiled",speed:500,width:590,compiledData:t,mapData:e})}}};var w=function(){_.each(rmData.program_data,S,this);_.each(rmData.location_data,x,this);_.each(rmData.program_events,E);l=_.sortBy(l,function(e){return new Date(e.date)})};var E=function(e){_tmp={};try{prog=_.findWhere(rmData.program_data,{program_code:e.program_code})}catch(t){prog={program_code:"err",title:"Program not found in data set"}}try{loca=_.findWhere(rmData.location_data,{location_code:e.location_code})}catch(t){loca={location_code:"err",location:"Location not found in data set"}}merge=_.extend(_tmp,prog,loca,e);l.push(merge)};var S=function(e){if(e!="undefined"&&e!=null){li=document.createElement("li");lbl=document.createElement("label");div=document.createElement("div");txt=document.createTextNode(""+e.title);inp=document.createElement("input");inp.type="checkbox";inp.value=e.program_code;lbl.appendChild(inp);div.appendChild(txt);lbl.appendChild(div);li.appendChild(lbl);$("#filter-topic > ul").append(li);r.push(lbl)}};var x=function(e){replaced_loc=e.location_code.replace(/[0-9]/g,"");locationInList=_.indexOf(u,replaced_loc)!=-1;if(e!="undefined"&&e!=null&&!locationInList){li=document.createElement("li");lbl=document.createElement("label");div=document.createElement("div");txt=document.createTextNode(""+e.city);inp=document.createElement("input");inp.type="checkbox";inp.value=replaced_loc;lbl.appendChild(inp);div.appendChild(txt);lbl.appendChild(div);li.appendChild(lbl);$("#filter-location > ul").append(li);r.push(lbl);u.push(replaced_loc)}};var T=function(e){o.month=e};return{init:c,filter:g,newMonth:T,eventsArray:l,month:o.month,startDate:f}}();$(function(){$.getScript("../includes/program-calendar-data.js",function(e,t,n){rskm.init({modal:UseModal})})})