<html>
<head>
    
    <link href="css/bootstrap.min.orig.css" rel="stylesheet">
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="css/textAngular.css">
    <script>
        function google_init(){
            
            //start app on google load
            console.log("gmap init");
            
        }
        
    </script>

    <style>
    .editor-view {
            margin-top: 5em;
    }

    .map-results-container {
        margin-top:1em;
        border-bottom:1px solid #ddd;
    }
    .event-btn-grp{
        padding-bottom:1em;
        border-bottom:1px solid #ddd;
		margin-bottom:1em;
    }
	
	.toggle-hidden{
		visibility:hidden;
		display:none;
	}
	.toggle-show {
		
	}
	
	#locMap {
		width:100%;
		height:200px;	
	}
    </style>
    
<title>MMLIS RM Program Finder</title>
</head>
<body>

<div id="map-container" class="container" data-ng-app="rm_data" data-ng-controller="data_ctrl">

<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">RM Data Editor</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav nav_">
        <li id="nav_events"><a href="#!/events/"> Events </a></li>
        <li id="nav_topics"><a href="#!/topics/"> Topics </a></li>
        <li id="nav_locations"><a href="#!/locations/"> Locations </a></li>
      </ul>

      <ul class="nav navbar-nav navbar-right">
        <li><a href="#" class="" ng-click="saveExport()"><span class="glyphicon glyphicon-floppy-save" ></span> Download JSON</a></li>
        <li><a href="#" class="" ng-click="fileOpen()"><span class="glyphicon glyphicon-open-file" ></span> Open JSON</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>




    <div ng-view class="editor-view"> view </div>
        
    
        
        
        
</div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="js/angular.min.js"></script>
    <script src="js/angular-route.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular-sanitize.js"></script>
    <script src="js/ui-bootstrap-tpls-2.3.2.min.js"></script>
    <script src="js/bootstrap.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/textAngular/1.5.0/textAngular-rangy.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/textAngular/1.5.0/textAngular-sanitize.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/textAngular/1.5.0/textAngular.min.js"></script>
    <script src="data/event-data-editor.json"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLahhfoVtxfV4AIjS-3v8MXCb-zn2ggH8">
    </script>

    <script>
        var dataLoaded = false;
		var map;
        var app = angular.module('rm_data', ['ui.bootstrap', 'ngSanitize',  'ngRoute','textAngular']);
        app.controller('data_ctrl', function($scope, $http, $filter, $sce) {
            
            //consider better method of handling data
            //if the data is already loaded into eventData, don't load it again on template update
            if(!dataLoaded){
                $http.get("data/event-data-beta.json").then(function (response) {
                    $scope.eventData = response.data;
                    //convert date strings into date objects
                    for(var i = 0; i < $scope.eventData.events.length; i++){
                        $scope.eventData.events[i].date = $scope.quickDate($scope.eventData.events[i].date);
                    }
                    dataLoaded = true;
                });
            }
			
			
            
            $scope.trix = '<div>Enter Text</div>';            
            
            $scope.newEvent = {};
            $scope.newTopic = null;
			$scope.newLocation = null;
            $scope.editTopic = 0;
            $scope.editTopicTitle = null;
            $scope.editTopicPresented = null;
            $scope.editTopicRegisterUrl = null;
			
			
			$scope.editLocation = 0;
			$scope.editLocationName = null;
			$scope.editFacility = null;
			$scope.editLocationAddress = null;
			$scope.editLocationCoords = {lat:0, lng:0};
			
			$scope.tog = {hide:"toggle-hidden", show:"toggle-show"};
			$scope.editShowHide = $scope.tog.hide;
			
			
//======================================================
//  Nav Toggle
//======================================================
            $scope.setNav = function(section){
                $(".nav_ > li").removeClass("active");
                $("#nav_"+section).addClass("active");
            }
            
			

			

            
			

            

//======================================================
//  File IO
//======================================================
			//Convert data for export and prompt file save
			$scope.saveExport = function(){
				var json = JSON.stringify($scope.eventData);
				var blob = new Blob([json], {type: "application/json"});
				var url  = URL.createObjectURL(blob);
				
				var a = document.createElement('a');
				a.download    = "education-programs-" + $filter('date')(new Date(),'yyyy.MM.dd') + ".json";
				console.log(a.download);
				a.href        = url;
				a.textContent = "download";
				a.click();
			}
			
			//Create file upload field and parse loaded json
			//TODO - Check data/structure before loading into app
			$scope.fileOpen = function(){
				var element = document.createElement('div');
				element.innerHTML = '<input type="file">';
				var fileInput = element.firstChild;
				
				fileInput.addEventListener('change', function() {
					var file = fileInput.files[0];
				
					if (file.name.match(/\.(txt|json)$/)) {
						var reader = new FileReader();
				
						reader.onload = function() {
							//console.log(reader.result);
							
                            
                            $scope.$apply(function(){
                                $scope.eventData = JSON.parse(reader.result);
                            });
                            
						};
				
						reader.readAsText(file); 
					} else {
						alert("File not supported, .txt or .json files only");
					}
				});	
				fileInput.click();
			}
			
			//function for date conversion options if needed.
			$scope.quickDate = function(str){
                return new Date(str);
            }

            
        });

angular.module("rm_data").controller("event_ctrl", function($scope){
//======================================================
//  Events
//======================================================
			//Add event button clicked. Modal attached to button
            $scope.showAddEvent = function(){
                $scope.newEvent = {id:Date.now(),location:'',date:new Date(),code:'',url:''};
            }
            
			//Add a new event
            $scope.addNewEvent = function(){
                $scope.eventData.events.push($scope.newEvent);
                $scope.newEvent = {};
            }

            //Watch output/display data change
//            $scope.$watchCollection('eventData', function(newData, oldData) {
//
//            });
            
			//Delete event on confirm
            $scope.confirmDeleteEvent = function(obj){
                //console.log("deleting event", obj, $scope.eventData.events[$scope.eventData.events.indexOf(obj)]);
                $scope.eventData.events.splice($scope.eventData.events.indexOf(obj),1);
            }

			//
            //$scope.eventTopicMatch = function(rel){
//                return $scope.getTopic[rel].concat($scope.getLocation(rel));
//            }
//            
//            //Watch output/display data change
//			$scope.$watchCollection('eventData.events.date', function(newData, oldData) {
//				console.log("date change", newData, oldData);
//			});
});
        
angular.module("rm_data").controller("topic_ctrl", function($scope){
//======================================================
//  Topics
//======================================================
            $scope.newTopic = function(){
                var newTop = {
                  "id": Date.now(),
                  "title": "New Topic",
                  "descriptionURL": "",
                  "description": {
                    "presentedBy": "",
                    "overviewHtml": "Overview.."
                    }
                };
                $scope.eventData.topics.push(newTop);
                $scope.editTopic = $scope.eventData.topics.indexOf(newTop) + "";
                $scope.setTopicDescription();
            }

            $scope.getTopic = function(rel){
                return $scope.eventData.topics[rel];
            }
            
            $scope.getCurrent = function(rel){
                return $index;
            }
            
            $scope.getTopics = function(){
                return $scope.eventData.topics;
            }
            
            $scope.setTopicDescription = function(){
				$scope.editShowHide = $scope.tog.show;
                $scope.trix = $scope.eventData.topics[$scope.editTopic].description.overviewHtml;
				$scope.editTopicTitle = $scope.eventData.topics[$scope.editTopic].title;
				$scope.editTopicPresentedBy = $scope.eventData.topics[$scope.editTopic].description.presentedBy;
				$scope.editTopicRegisterUrl = $scope.eventData.topics[$scope.editTopic].descriptionURL;
            }
            
            $scope.saveTopicDescription = function(){

                if(confirm("Update Topic Information?")){
                    $scope.eventData.topics[$scope.editTopic].description.overviewHtml = $scope.trix;
                    
                    $scope.eventData.topics[$scope.editTopic].title = $scope.editTopicTitle;
                    $scope.eventData.topics[$scope.editTopic].description.presentedBy = $scope.editTopicPresentedBy;
                    $scope.eventData.topics[$scope.editTopic].descriptionURL = $scope.editTopicRegisterUrl;
                }

            }
            
            $scope.deleteCurrentTopic = function(){
                if(confirm("This will remove this topics and any events attached to it. Continue?")){
                    
                    //remove topic
                    $scope.eventData.topics.splice($scope.editTopic,1);
                    
                    //hide editor
                    $scope.editShowHide = $scope.tog.hide;
                    
                    // iterate events to remove events associated with topic, and shift references to match new topic indices
                    for(var i=0; i<$scope.eventData.events.length; i++){
                        if($scope.eventData.events[i].topic == $scope.editTopic){
                            //remove events with topic
                            console.log("removing", $scope.eventData.events[i]);
                            console.log($scope.eventData.events.splice(i,1));
                            
                        }
                    }
                    //adjust remaining events for topic references
                    for(var i=0; i<$scope.eventData.events.length; i++){
                     if($scope.eventData.events[i].topic>$scope.editTopic){
                            //shift events topic index refs
                            $scope.eventData.events[i].topic = $scope.eventData.events[i].topic-1; //shift topic down
                         
                            
                        }
                    }
                    
                    $scope.editTopic = 0;
                    
                    //$scope.$apply();
                }
            }
});
        
angular.module("rm_data").controller("location_ctrl", function($scope){
//======================================================
//  Locations
//======================================================
            $scope.newLocation = function(){
                //add placeholder location to array
                var newLoc = {
                  "id": Date.now(),
                  "locationName": "NewLocation",
                  "facility": "",
                  "address": "",
                  "coordinates": {
                    "lat": 39.4984581,
                    "lng": -76.66619149999997
                  }
                };

                $scope.eventData.locations.push(newLoc);
                
                $scope.editLocation = $scope.eventData.locations.indexOf(newLoc) + "";
                $scope.setLocation();
                
            }

			$scope.setLocation = function(){
				$scope.editShowHide = $scope.tog.show;
				$scope.editLocationName = $scope.eventData.locations[$scope.editLocation].locationName;
				$scope.editFacility = $scope.eventData.locations[$scope.editLocation].facility;
				$scope.editLocationAddress = $scope.eventData.locations[$scope.editLocation].address;
				$scope.editLocationCoords = {
					"lat": $scope.eventData.locations[$scope.editLocation].coordinates.lat,
					"lng": $scope.eventData.locations[$scope.editLocation].coordinates.lng
				};
				$scope.updateLocationMap();
			}
			
			$scope.updateLocationMap = function(){
				map = new google.maps.Map(document.getElementById('locMap'), {
				  center: $scope.editLocationCoords,
				  zoom: 15
				});	
				var marker = new google.maps.Marker({
				  position: $scope.editLocationCoords,
				  map: map,
				  title: $scope.editLocationAddress
				});
			}

            $scope.saveLocation = function(){
                //$scope.editShowHide = tog.show;
                if(confirm("Update Location Information?")){
                    $scope.eventData.locations[$scope.editLocation].locationName = $scope.editLocationName;
                    $scope.eventData.locations[$scope.editLocation].facility = $scope.editFacility;
                    $scope.eventData.locations[$scope.editLocation].address = $scope.editLocationAddress;
                    $scope.eventData.locations[$scope.editLocation].coordinates = {
                        "lat": $scope.editLocationCoords.lat,
                        "lng": $scope.editLocationCoords.lng
                    };
                }

            }
            
            $scope.deleteCurrentLocation = function(){
                if(confirm("This will remove this location and any events attached to it. Continue?")){
                    $scope.eventData.locations.splice($scope.editLocation,1);
                    
                    $scope.editShowHide = $scope.tog.hide;
                    
                    //remove events with location
                    //shift events location index refs
                    // iterate events to remove events associated with topic, and shift references to match new topic indices
                    for(var i=0; i<$scope.eventData.events.length; i++){
                        
                        if($scope.eventData.events[i].location == $scope.editLocation){
                            //remove events with topic
                            $scope.eventData.events.splice(i,1);
                        }
                    }
                    //adjust remaining events for location references
                    for(var i=0; i<$scope.eventData.events.length; i++){
                        if($scope.eventData.events[i].location>$scope.editLocation){
                            //shift events topic index refs
                            //console.log("Shifting topic ref ", $scope.eventData.events[i].location, $scope.eventData.events[i].location-1);
                            $scope.eventData.events[i].location = $scope.eventData.events[i].location-1; //shift topic down
                        }
                    }
                    
                    $scope.editLocation = 0;
                }
            }
			
			$scope.getLatLngGoogle = function(){
				//http://maps.google.com/maps/api/geocode/json?address=
				$http.get("//maps.google.com/maps/api/geocode/json?address="+$scope.editLocationAddress).then(function (response) {
                    var dat = response.data;
                    //convert date strings into date objects
					console.log(dat.results);
                    if(typeof dat.results[0] != "undefined"){
						$scope.editLocationCoords.lat = dat.results[0].geometry.location.lat;
						$scope.editLocationCoords.lng = dat.results[0].geometry.location.lng;
						$scope.updateLocationMap();
					}
                    
                });
			}
			
            $scope.getLocation = function(rel){
                return $scope.eventData.locations[rel].facility;
            }
});


var routeParams = [];
/* Routes */
app.config(['$routeProvider',
  function($routeProvider) {
    $routeProvider.
      when('/locations/:locationId?', {
        templateUrl: 'partials/locations.html',
        controller: 'location_ctrl'
      }).
      when('/topics/:topicId?', {
        templateUrl: 'partials/topics.html',
        controller: 'topic_ctrl'
      }).
      when('/events/:eventId?', {
        templateUrl: 'partials/events.html',
        controller: 'event_ctrl'
      }).
      otherwise({
        templateUrl: 'partials/events.html',
        controller: 'event_ctrl'
      });
  }]);
  
  /*app.factory('dataService', function() {
        var _data = {};
        return {
            getData:function(){return _data;},
            setData:function(data){_data=data;}
        };
    });*/


    </script>
    


    
</body>