<html>
<head>
    
    <link href="css/bootstrap.min.orig.css" rel="stylesheet">
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="css/textAngular.css">
    <script>
        function google_init(){
            
            //start app on google load
            console.log("gmap init");
            
        }
        
    </script>

    <style>
    .editor-view {
            margin-top: 5em;
    }

    .map-results-container {
        margin-top:1em;
        border-bottom:1px solid #ddd;
    }
    .event-btn-grp{
        padding-bottom:1em;
        border-bottom:1px solid #ddd;
		margin-bottom:1em;
    }
	
	.toggle-hidden{
		visibility:hidden;
		display:none;
	}
	.toggle-show {
		
	}
	
	#locMap {
		width:100%;
		height:200px;	
	}
    </style>
    
<title>MMLIS RM Program Finder</title>
</head>
<body>

<div id="map-container" class="container" data-ng-app="rm_data" data-ng-controller="data_ctrl">

<nav class="navbar navbar-default navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="#">RM Data Editor</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav nav_">
        <li id="nav_events"><a href="#!/events/"> Events </a></li>
        <li id="nav_topics"><a href="#!/topics/"> Topics </a></li>
        <li id="nav_locations"><a href="#!/locations/"> Locations </a></li>
      </ul>

      <ul class="nav navbar-nav navbar-right">
        <li><a href="#" class="" ng-click="saveExport()"><span class="glyphicon glyphicon-floppy-save" ></span> Download JSON</a></li>
        <li><a href="#" class="" ng-click="fileOpen()"><span class="glyphicon glyphicon-open-file" ></span> Open JSON</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>




    <div ng-view class="editor-view"> view </div>
        
    <!-- Modal -->
    <div class="modal fade" id="addEventModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">Add Event</h4>
          </div>
          <div class="modal-body">
                <div class="map-results-each row">
                    <div class="result-date col-sm-3">
                        <input ng-model="newEvent.date" class="form-control shadow" placeholder="Date" type="date">

                    </div>

                    <div class="col-sm-6">


                        <select class="form-control shadow" data-live-search="true" ng-model="newEvent.topic" ng-options="topic.id as topic.title for topic in eventData.topics">

                        </select>


                        <br>
                        <select class="form-control shadow" data-live-search="true" ng-model="newEvent.location" ng-options="location.id as location.locationName for location in eventData.locations">
                        </select>
                    </div>

                    <div class="col-sm-3">
                        <input ng-model="newEvent.code" class="form-control shadow" placeholder="Code"><br>
                        <input ng-model="newEvent.url" class="form-control shadow" placeholder="Register URL">
                    </div>


                </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" ng-click="addNewEvent()" data-dismiss="modal">Save</button>
          </div>
        </div>
      </div>
    </div>
        
        
        
</div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="js/angular.min.js"></script>
    <script src="js/angular-route.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular-sanitize.js"></script>
    <script src="js/ui-bootstrap-tpls-2.3.2.min.js"></script>
    <script src="js/bootstrap.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/textAngular/1.5.0/textAngular-rangy.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/textAngular/1.5.0/textAngular-sanitize.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/textAngular/1.5.0/textAngular.min.js"></script>
    <script src="data/event-data-editor.json"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDLahhfoVtxfV4AIjS-3v8MXCb-zn2ggH8">
    </script>

    <script>
        var dataLoaded = false;
		var map;
        var app = angular.module('rm_data', ['ui.bootstrap', 'ngSanitize',  'ngRoute','textAngular']);
        app.controller('data_ctrl', function($scope, $http, $filter, $sce) {
            
            //consider better method of handling data
            //if the data is already loaded into eventData, don't load it again on template update
            if(!dataLoaded){
                $http.get("data/event-data.json").then(function (response) {
                    $scope.eventData = response.data;
                    //convert date strings into date objects
                    for(var i = 0; i < $scope.eventData.events.length; i++){
                        $scope.eventData.events[i].date = $scope.quickDate($scope.eventData.events[i].date);
                    }
                    dataLoaded = true;
                });
            }
			
			
            
            $scope.trix = '<div>Enter Text</div>';            
            
            $scope.newEvent = null;
            $scope.newTopic = null;
			$scope.newLocation = null;
            $scope.editTopic = 0;
            $scope.editTopicTitle = null;
            $scope.editTopicPresented = null;
            $scope.editTopicRegisterUrl = null;
			
			
			$scope.editLocation = 0;
			$scope.editLocationName = null;
			$scope.editFacility = null;
			$scope.editLocationAddress = null;
			$scope.editLocationCoords = {lat:0, lng:0};
			
			var tog = {hide:"toggle-hidden", show:"toggle-show"};
			$scope.editShowHide = tog.hide;
			
			
//======================================================
//  Nav Toggle
//======================================================
            $scope.setNav = function(section){
                $(".nav_ > li").removeClass("active");
                $("#nav_"+section).addClass("active");
            }
            
			
//======================================================
//  Topics
//======================================================
            $scope.getTopic = function(rel){
                return $scope.eventData.topics[rel];
            }
            
            $scope.getCurrent = function(rel){
                return $index;
            }
            
            $scope.getTopics = function(){
                return $scope.eventData.topics;
            }
            
            $scope.setTopicDescription = function(){
				$scope.editShowHide = tog.show;
                $scope.trix = $scope.eventData.topics[$scope.editTopic].description.overviewHtml;
				$scope.editTopicTitle = $scope.eventData.topics[$scope.editTopic].title;
				$scope.editTopicPresentedBy = $scope.eventData.topics[$scope.editTopic].description.presentedBy;
				$scope.editTopicRegisterUrl = $scope.eventData.topics[$scope.editTopic].descriptionURL;
            }
            
            $scope.saveTopicDescription = function(){

                if(confirm("Update Topic Information?")){
                    $scope.eventData.topics[$scope.editTopic].description.overviewHtml = $scope.trix;
                    
                    $scope.eventData.topics[$scope.editTopic].title = $scope.editTopicTitle;
                    $scope.eventData.topics[$scope.editTopic].description.presentedBy = $scope.editTopicPresentedBy;
                    $scope.eventData.topics[$scope.editTopic].descriptionURL = $scope.editTopicRegisterUrl;
                }

            }
			
//======================================================
//  Locations
//======================================================
			$scope.setLocation = function(){
				$scope.editShowHide = tog.show;
				$scope.editLocationName = $scope.eventData.locations[$scope.editLocation].locationName;
				$scope.editFacility = $scope.eventData.locations[$scope.editLocation].facility;
				$scope.editLocationAddress = $scope.eventData.locations[$scope.editLocation].address;
				$scope.editLocationCoords = {
					"lat": $scope.eventData.locations[$scope.editLocation].coordinates.lat,
					"lng": $scope.eventData.locations[$scope.editLocation].coordinates.lng
				};
				$scope.updateLocationMap();
			}
			
			$scope.updateLocationMap = function(){
				map = new google.maps.Map(document.getElementById('locMap'), {
				  center: $scope.editLocationCoords,
				  zoom: 15
				});	
				var marker = new google.maps.Marker({
				  position: $scope.editLocationCoords,
				  map: map,
				  title: $scope.editLocationAddress
				});
			}
			
			$scope.getLatLngGoogle = function(){
				//http://maps.google.com/maps/api/geocode/json?address=
				$http.get("//maps.google.com/maps/api/geocode/json?address="+$scope.editLocationAddress).then(function (response) {
                    var dat = response.data;
                    //convert date strings into date objects
					console.log(dat.results);
                    if(typeof dat.results[0] != "undefined"){
						$scope.editLocationCoords.lat = dat.results[0].geometry.location.lat;
						$scope.editLocationCoords.lng = dat.results[0].geometry.location.lng;
						$scope.updateLocationMap();
					}
                    
                });
			}
			
            $scope.getLocation = function(rel){
                return $scope.eventData.locations[rel].facility;
            }
            
			
//======================================================
//  Events
//======================================================
			//Add event button clicked. Modal attached to button
            $scope.showAddEvent = function(){
                $scope.newEvent = {id:'',location:'',date:'',code:'',url:''};
            }
            
			//Add a new event
            $scope.addNewEvent = function(){
                $scope.eventData.events.push($scope.newEvent);
            }

            //Watch output/display data change
//            $scope.$watchCollection('eventData', function(newData, oldData) {
//
//            });
            
			//Delete event on confirm
            $scope.confirmDeleteEvent = function(obj){
                //console.log("deleting event", obj, $scope.eventData.events[$scope.eventData.events.indexOf(obj)]);
                $scope.eventData.events.splice($scope.eventData.events.indexOf(obj),1);
            }

			//
            //$scope.eventTopicMatch = function(rel){
//                return $scope.getTopic[rel].concat($scope.getLocation(rel));
//            }
//            
//            //Watch output/display data change
//			$scope.$watchCollection('eventData.events.date', function(newData, oldData) {
//				console.log("date change", newData, oldData);
//			});
            

//======================================================
//  File IO
//======================================================
			//Convert data for export and prompt file save
			$scope.saveExport = function(){
				var json = JSON.stringify($scope.eventData);
				var blob = new Blob([json], {type: "application/json"});
				var url  = URL.createObjectURL(blob);
				
				var a = document.createElement('a');
				a.download    = "education-programs-" + $filter('date')(new Date(),'yyyy.MM.dd') + ".json";
				console.log(a.download);
				a.href        = url;
				a.textContent = "download";
				a.click();
			}
			
			//Create file upload field and parse loaded json
			//TODO - Check data/structure before loading into app
			$scope.fileOpen = function(){
				var element = document.createElement('div');
				element.innerHTML = '<input type="file">';
				var fileInput = element.firstChild;
				
				fileInput.addEventListener('change', function() {
					var file = fileInput.files[0];
				
					if (file.name.match(/\.(txt|json)$/)) {
						var reader = new FileReader();
				
						reader.onload = function() {
							console.log(reader.result);
							$scope.eventData = JSON.parse(reader.result);
						};
				
						reader.readAsText(file);    
					} else {
						alert("File not supported, .txt or .json files only");
					}
				});	
				fileInput.click();
			}
			
			//function for date conversion options if needed.
			$scope.quickDate = function(str){
                return new Date(str);
            }

            
        });




var routeParams = [];
/* Routes */
app.config(['$routeProvider',
  function($routeProvider) {
    $routeProvider.
      when('/locations/:locationId?', {
        templateUrl: 'partials/locations.html',
        controller: 'data_ctrl'
      }).
      when('/topics/:topicId?', {
        templateUrl: 'partials/topics.html',
        controller: 'data_ctrl'
      }).
      when('/events/', {
        templateUrl: 'partials/events.html',
        controller: 'data_ctrl'
      }).
      otherwise({
        templateUrl: 'partials/events.html',
        controller: 'data_ctrl'
      });
  }]);
  
  /*app.factory('dataService', function() {
        var portfolioData = {};
        return {
            getData:function(){return portfolioData;},
            setData:function(data){portfolioData=data;}
        };
    });*/

/*  portfolioApp.directive('sample', function () {
    return {
        restrict: "E",
        replace: true,
        transclude: true,
        template: "<div></div>",
        controller: function ($scope, $element) {
            this.act = function (something) {
               $($element).trigger("imageModal.launch", [something]);
            };
        }
    };
})*/

/*function ContactController($scope, $routeParams){ 
    $scope.contactSubmit = function(id, session){
        console.log("session id - prevent spam with timer", session);
        console.log(document.getElementById(id));
    }
}*/


/* Controllers */
//var dataControllers = angular.module('dataControllers', []);
//dataControllers.controller('locationsControl', ['$scope', '$http', '$routeParams', 
//  function($scope, $http, $routeParams, dataService) {
//        /*$http.get('data/portfolio.json').success(function(data) {
//          $scope.workItems = _.where(data, {"category" : $routeParams.subCategory || "web"});
//          jsonData = data;
//        });*/
//
//    $scope.orderProp = 'id';
//    $scope.category = $routeParams.locationId;
//    routeParams = $routeParams;
//    console.log("category", $scope.category);
//  }]);
//
//dataControllers.controller('topicsControl', ['$scope','$http', '$routeParams', '$sce',
//  function($scope, $http, $routeParams, $sce) {
//        /*$http.get('data/portfolio.json').success(function(data) {
//          first = _.where(data, {"id" : $routeParams.itemId});
//          second = _.where(first[0].images, {"id" : $routeParams.mediaId});
//          $scope.gallery = first[0].images;
//          $scope.dataItem = second[0];
//          $scope.trustedURL = $sce.trustAsUrl($scope.dataItem.fullUrl);
//        }); */
//    $scope.orderProp = 'id';
//    $scope.category = $routeParams.topicId;
//    routeParams = $routeParams;
//    console.log("category", $scope.category);
//    
//    
//  }]);

    </script>
    


    
</body>