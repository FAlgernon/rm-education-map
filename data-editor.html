<html>
<head>
    <link rel="stylesheet" type="text/css" href="css/rm-map.css">
    <link href="css/bootstrap.min.orig.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.3.0/css/datepicker.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/trix/0.9.2/trix.css">
    <script>
        function google_init(){
            
            //start app on google load
            console.log("gmap init");
            
        }
        
    </script>
    
<title>MMLIS RM Program Finder</title>
</head>
<body>

<div id="map-container" data-ng-app="rm_data" data-ng-controller="data_ctrl">
    <div class="row">
        <a class="col-3" href="#!/events/"> Events </a>
        <a class="col-3" href="#!/topics/"> Topics </a>
        <a class="col-3" href="#!/locations/"> Locations </a>
    </div>
    <div ng-view class="editor-view"> view </div>
        
    <!-- Modal -->
    <div class="modal fade" id="addEventModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">Add Event</h4>
          </div>
          <div class="modal-body">
                <div class="map-results-each row">
                    <div class="result-date col-sm-3">
                        <input ng-model="newEvent.date" class="form-control shadow" placeholder="Date" type="date">

                    </div>

                    <div class="col-sm-6">


                        <select class="form-control shadow" data-live-search="true" ng-model="newEvent.topic" ng-options="topic.id as topic.title for topic in eventData.topics">

                        </select>


                        <br>
                        <select class="form-control shadow" data-live-search="true" ng-model="newEvent.location" ng-options="location.id as location.locationName for location in eventData.locations">
                        </select>
                    </div>

                    <div class="col-sm-3">
                        <input ng-model="newEvent.code" class="form-control shadow" placeholder="Code"><br>
                        <input ng-model="newEvent.url" class="form-control shadow" placeholder="Register URL">
                    </div>


                </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" ng-click="addNewEvent()" data-dismiss="modal">Save</button>
          </div>
        </div>
      </div>
    </div>
        
        
        
</div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="js/angular.min.js"></script>
    <script src="js/angular-route.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular-sanitize.js"></script>
    <script src="js/ui-bootstrap-tpls-2.3.2.min.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/trix/0.9.2/trix.js"></script>
    <script src="js/angular-trix.js"></script>
    <script src="data/event-data-editor.json"></script>

    <script>
        var dataLoaded = false;
        var app = angular.module('rm_data', ['ui.bootstrap', 'ngSanitize',  'ngRoute','angularTrix']);
        app.controller('data_ctrl', function($scope, $http, $filter, $sce) {
            
            //consider better method of handling data
            //if the data is already loaded into eventData, don't load it again on template update
            if(!dataLoaded){
                $http.get("data/event-data.json").then(function (response) {
                    $scope.eventData = response.data;
                    //convert date strings into date objects
                    for(var i = 0; i < $scope.eventData.events.length; i++){
                        $scope.eventData.events[i].date = $scope.quickDate($scope.eventData.events[i].date);
                    }
                    dataLoaded = true;
                });
            }
            
            $scope.trix = '<div>Enter Text</div>';
            
             var events = ['trixInitialize',/* 'trixChange', */'trixSelectionChange', 'trixFocus', 'trixBlur', 'trixFileAccept', 'trixAttachmentAdd', 'trixAttachmentRemove'];
            for (var i = 0; i < events.length; i++) {
                $scope[events[i]] = function(e) {
                    console.info('Event type:', e.type);
                }
            };
            
            $scope.trixChange = function(e){
                console.log("trix change", $scope.editTopic, $scope.eventData.topics[$scope.editTopic].description.overviewHtml);
            }
            
            
            $scope.newEvent = null;
            $scope.newTopic = null;
            $scope.editTopic = null;
            
            $scope.getTopic = function(rel){
                return $scope.eventData.topics[rel];
            }
            
            $scope.getCurrent = function(rel){
                return $index;
            }
            
            $scope.getTopics = function(){
                return $scope.eventData.topics;
            }
            
            $scope.setTopicDescription = function(){
                $scope.trix = $scope.eventData.topics[$scope.editTopic].description.overviewHtml;
            }
            
            $scope.saveTopicDescription = function(){
                $scope.eventData.topics[$scope.editTopic].description.overviewHtml = $scope.trix;
                //$scope.$apply();
                console.log($scope.eventData.topics[$scope.editTopic].description.overviewHtml);
            }
            
            $scope.getLocation = function(rel){
                return $scope.eventData.locations[rel].facility;
            }
            
            $scope.showAddEvent = function(){
                $scope.newEvent = {id:'',location:'',date:'',code:'',url:''};
            }
            
            $scope.quickDate = function(str){
                return new Date(str);
            }
            
            $scope.addNewEvent = function(){
                $scope.eventData.events.push($scope.newEvent);
                //$scope.$apply();
            }

            //Watch output/display data change
            $scope.$watchCollection('eventData', function(newData, oldData) {
                //$scope.$apply();
                console.log("data change");
            });
            
            $scope.confirmDeleteEvent = function(obj){
                console.log("deleting event", obj, $scope.eventData.events[$scope.eventData.events.indexOf(obj)]);
                $scope.eventData.events.splice($scope.eventData.events.indexOf(obj),1);
                //$scope.$apply();
            }
            
            $scope.eventTopicMatch = function(rel){
                
                return $scope.getTopic[rel].concat($scope.getLocation(rel));
            }
            
            //Watch output/display data change
			$scope.$watchCollection('eventData.events.date', function(newData, oldData) {
				console.log("date change", newData, oldData);
			});
            
            $scope.$watchCollection('trix', function(newData, oldData) {
				console.log("trix change", $scope.editTopic);
                
			});

            
        });




var routeParams = [];
/* Routes */
app.config(['$routeProvider',
  function($routeProvider) {
    $routeProvider.
      when('/locations/:locationId?', {
        templateUrl: 'partials/locations.html',
        controller: 'data_ctrl'
      }).
      when('/topics/:topicId?', {
        templateUrl: 'partials/topics.html',
        controller: 'data_ctrl'
      }).
      when('/events/', {
        templateUrl: 'partials/events.html',
        controller: 'data_ctrl'
      }).
      otherwise({
        templateUrl: 'partials/events.html',
        controller: 'data_ctrl'
      });
  }]);
  
  /*app.factory('dataService', function() {
        var portfolioData = {};
        return {
            getData:function(){return portfolioData;},
            setData:function(data){portfolioData=data;}
        };
    });*/

/*  portfolioApp.directive('sample', function () {
    return {
        restrict: "E",
        replace: true,
        transclude: true,
        template: "<div></div>",
        controller: function ($scope, $element) {
            this.act = function (something) {
               $($element).trigger("imageModal.launch", [something]);
            };
        }
    };
})*/

/*function ContactController($scope, $routeParams){ 
    $scope.contactSubmit = function(id, session){
        console.log("session id - prevent spam with timer", session);
        console.log(document.getElementById(id));
    }
}*/


/* Controllers */
var dataControllers = angular.module('dataControllers', []);
dataControllers.controller('locationsControl', ['$scope', '$http', '$routeParams', 
  function($scope, $http, $routeParams, dataService) {
        /*$http.get('data/portfolio.json').success(function(data) {
          $scope.workItems = _.where(data, {"category" : $routeParams.subCategory || "web"});
          jsonData = data;
        });*/

    $scope.orderProp = 'id';
    $scope.category = $routeParams.locationId;
    routeParams = $routeParams;
    console.log("category", $scope.category);
  }]);

dataControllers.controller('topicsControl', ['$scope','$http', '$routeParams', '$sce',
  function($scope, $http, $routeParams, $sce) {
        /*$http.get('data/portfolio.json').success(function(data) {
          first = _.where(data, {"id" : $routeParams.itemId});
          second = _.where(first[0].images, {"id" : $routeParams.mediaId});
          $scope.gallery = first[0].images;
          $scope.dataItem = second[0];
          $scope.trustedURL = $sce.trustAsUrl($scope.dataItem.fullUrl);
        }); */
    $scope.orderProp = 'id';
    $scope.category = $routeParams.topicId;
    routeParams = $routeParams;
    console.log("category", $scope.category);
    
    
  }]);

    </script>
    


    
</body>